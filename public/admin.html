<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Admin Dashboard - MoProPrep</title>
    <link rel="stylesheet" href="style.css">
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-auth.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-firestore.js"></script>
    <script src="firebase-config.js"></script>
</head>

<body class="admin-body">
    <div class="app-container">
        <header class="glass-header">
            <a href="/" class="logo"
                style="text-decoration: none; color: inherit; display: flex; align-items: center; gap: 0.5rem;">
                <span class="logo-icon">ü©∫</span>
                <h1>MoProPrep Admin</h1>
            </a>
            <div style="display: flex; gap: 0.5rem;">
                <button id="btn-view-stats" class="secondary-btn" style="padding: 0.5rem 1rem;">Analytics üìä</button>
                <button id="btn-logout" class="icon-btn">Logout</button>
            </div>

        </header>

        <main id="admin-content" style="display: none;">
            <div class="stats-grid">
                <div class="glass-card stat-card">
                    <h3>Total Users</h3>
                    <p id="total-users">0</p>
                </div>
                <div class="glass-card stat-card">
                    <h3>Pro Members</h3>
                    <p id="pro-users">0</p>
                </div>
            </div>

            <div class="glass-card" style="margin-top: 2rem;">
                <h2>Pricing Control</h2>
                <div style="display: flex; gap: 1rem; align-items: center; margin-top: 1rem;">
                    <label for="pro-price">Pro Membership Price (INR):</label>
                    <input type="number" id="pro-price" min="1" value="299"
                        style="padding: 0.5rem; border-radius: 8px; border: 1px solid #555; background: #222; color: #fff; width: 100px;">
                    <button id="btn-save-price" class="primary-btn" style="padding: 0.5rem 1rem;">Save Price</button>
                </div>
                <p id="price-status" style="margin-top: 0.5rem; font-size: 0.9rem; color: #888;"></p>
            </div>

            <div class="glass-card" style="margin-top: 2rem;">
                <h2>User Feedback & Ratings</h2>
                <div style="max-height: 400px; overflow-y: auto; margin-top: 1rem;">
                    <table id="feedback-table" style="width: 100%; border-collapse: collapse;">
                        <thead>
                            <tr style="text-align: left; border-bottom: 1px solid rgba(255,255,255,0.1);">
                                <th>Date</th>
                                <th>User</th>
                                <th>Rating</th>
                                <th>Suggestion</th>
                            </tr>
                        </thead>
                        <tbody>
                            <tr>
                                <td colspan="4" style="text-align: center; padding: 1rem;">Loading feedback...</td>
                            </tr>
                        </tbody>
                    </table>
                </div>
            </div>

            <div class="glass-card" style="margin-top: 2rem;">
                <h2>User List</h2>

                <!-- Search Box -->
                <div style="margin-bottom: 1rem;">
                    <input type="text" id="user-search" placeholder="Search by name or email..."
                        style="width: 100%; padding: 0.75rem; border-radius: 8px; border: 1px solid #555; background: #222; color: #fff; font-size: 1rem;">
                </div>

                <!-- Pagination Controls -->
                <div id="pagination-controls"
                    style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 1rem;">
                    <button id="prev-page" class="secondary-btn"
                        style="padding: 0.5rem 1rem; opacity: 1; transition: opacity 0.3s;" disabled>‚Üê
                        Previous</button>
                    <span id="page-info" style="color: #888;">Page 1 of 1</span>
                    <button id="next-page" class="secondary-btn"
                        style="padding: 0.5rem 1rem; opacity: 1; transition: opacity 0.3s;" disabled>Next ‚Üí</button>
                </div>

                <style>
                    .secondary-btn:disabled {
                        opacity: 0.4 !important;
                        cursor: not-allowed;
                        pointer-events: none;
                    }
                </style>

                <table id="user-table" style="width: 100%; border-collapse: collapse;">
                    <thead>
                        <tr style="text-align: left; border-bottom: 1px solid rgba(255,255,255,0.1);">
                            <th>Name</th>
                            <th>Email</th>
                            <th>Status</th>
                            <th>Actions</th>
                        </tr>
                    </thead>
                    <tbody></tbody>
                </table>
            </div>
        </main>

        <div id="login-overlay"
            style="display: flex; height: 80vh; align-items: center; justify-content: center; flex-direction: column;">
            <h2>Admin Login Required</h2>
            <p>Only the specific admin email can access this.</p>
            <button id="btn-admin-login" class="primary-btn">Login with Google</button>
        </div>
    </div>

    <script>
        const ADMIN_EMAIL = "adityasonofashok@gmail.com";

        auth.onAuthStateChanged(async (user) => {
            if (user && user.email === ADMIN_EMAIL) {
                document.getElementById('login-overlay').style.display = 'none';
                document.getElementById('admin-content').style.display = 'block';
                document.getElementById('admin-content').style.display = 'block';
                loadStats();
                loadFeedback(); // Load user feedback
                loadPrice(); // Load current price
            } else if (user) {
                alert("Unauthorized. Access denied.");
                auth.signOut();
            }
        });

        document.getElementById('btn-admin-login').onclick = () => auth.signInWithPopup(provider);
        document.getElementById('btn-logout').onclick = () => auth.signOut().then(() => location.reload());
        document.getElementById('btn-view-stats').onclick = () => window.location.href = 'stats.html';


        // --- Price Control Logic ---
        async function loadPrice() {
            try {
                const doc = await db.collection('settings').doc('pricing').get();
                if (doc.exists) {
                    document.getElementById('pro-price').value = doc.data().amount || 299;
                    document.getElementById('price-status').innerText = 'Loaded from Firestore.';
                } else {
                    // Create default pricing doc
                    await db.collection('settings').doc('pricing').set({ amount: 299 });
                    document.getElementById('price-status').innerText = 'Default price set (299).';
                }
            } catch (e) {
                console.error("Failed to load price:", e);
                document.getElementById('price-status').innerText = 'Error loading price.';
            }
        }

        document.getElementById('btn-save-price').onclick = async () => {
            const priceInput = document.getElementById('pro-price');
            const newPrice = parseInt(priceInput.value);
            if (isNaN(newPrice) || newPrice < 1) {
                alert("Please enter a valid price (minimum 1).");
                return;
            }
            document.getElementById('price-status').innerText = 'Saving...';
            try {
                console.log("Saving price:", newPrice, "to settings/pricing");
                await db.collection('settings').doc('pricing').set({ amount: newPrice }, { merge: true });
                document.getElementById('price-status').innerText = 'Price updated to ‚Çπ' + newPrice + ' at ' + new Date().toLocaleTimeString();
                console.log("Price saved successfully!");
            } catch (e) {
                console.error("Failed to save price:", e.message, e.code, e);
                document.getElementById('price-status').innerText = 'Error: ' + e.message;
                alert("Failed to save price: " + e.message);
            }
        };

        // --- Toggle Pro Status ---
        async function toggleProStatus(uid, currentStatus, displayName) {
            const newStatus = !currentStatus;
            const action = newStatus ? 'grant PRO to' : 'remove PRO from';

            if (!confirm(`Are you sure you want to ${action} ${displayName || uid}?`)) {
                return;
            }

            try {
                await db.collection('users').doc(uid).update({
                    isPro: newStatus,
                    proModifiedAt: firebase.firestore.FieldValue.serverTimestamp(),
                    proModifiedBy: 'admin'
                });

                alert(`Successfully ${newStatus ? 'granted' : 'removed'} PRO status for ${displayName || uid}`);
                loadStats(); // Refresh the list
            } catch (e) {
                console.error("Failed to toggle Pro status:", e);
                alert("Failed to update Pro status: " + e.message);
            }
        }

        // --- User Feedback Logic ---
        async function loadFeedback() {
            try {
                const feedbackSnap = await db.collection('feedback').orderBy('timestamp', 'desc').get();
                const tableBody = document.querySelector('#feedback-table tbody');
                tableBody.innerHTML = '';

                if (feedbackSnap.empty) {
                    tableBody.innerHTML = '<tr><td colspan="4" style="text-align: center; padding: 1rem;">No feedback received yet.</td></tr>';
                    return;
                }

                feedbackSnap.forEach(doc => {
                    const f = doc.data();
                    const date = f.timestamp ? f.timestamp.toDate().toLocaleDateString() : 'N/A';
                    const stars = '‚≠ê'.repeat(f.rating) + '‚òÜ'.repeat(5 - f.rating);

                    const row = `<tr style="border-bottom: 1px solid rgba(255,255,255,0.05);">
                        <td style="padding: 0.8rem 0; font-size: 0.85rem;">${date}</td>
                        <td style="padding: 0.8rem 0; font-size: 0.85rem;">${f.userEmail || 'Anonymous'}</td>
                        <td style="padding: 0.8rem 0; color: #FFD700;">${stars}</td>
                        <td style="padding: 0.8rem 0; font-size: 0.85rem; max-width: 300px; white-space: normal; word-break: break-all;">${f.suggestion || 'No suggestion'}</td>
                    </tr>`;
                    tableBody.insertAdjacentHTML('beforeend', row);
                });
            } catch (e) {
                console.error("Failed to load feedback:", e);
                document.querySelector('#feedback-table tbody').innerHTML = '<tr><td colspan="4" style="text-align: center; padding: 1rem; color: #f87171;">Error loading feedback.</td></tr>';
            }
        }

        // --- Pagination & Search State ---
        let allUsers = [];
        let filteredUsers = [];
        let currentPage = 1;
        const usersPerPage = 10;

        const PRIORITY_TERMS = ['moproprep', 'mopro', 'state mo', 'mo'];

        // --- Search Event Listener ---
        document.getElementById('user-search').addEventListener('input', (e) => {
            const query = e.target.value.toLowerCase().trim();
            if (query === '') {
                filteredUsers = [...allUsers];
            } else {
                filteredUsers = allUsers.filter(u =>
                    (u.displayName && u.displayName.toLowerCase().includes(query)) ||
                    (u.email && u.email.toLowerCase().includes(query))
                );

                // Prioritization logic: matches containing Priority Terms go to top
                filteredUsers.sort((a, b) => {
                    const aName = (a.displayName || '').toLowerCase();
                    const aEmail = (a.email || '').toLowerCase();
                    const bName = (b.displayName || '').toLowerCase();
                    const bEmail = (b.email || '').toLowerCase();

                    const aPrio = PRIORITY_TERMS.some(t => aName.includes(t) || aEmail.includes(t));
                    const bPrio = PRIORITY_TERMS.some(t => bName.includes(t) || bEmail.includes(t));

                    if (aPrio && !bPrio) return -1;
                    if (!aPrio && bPrio) return 1;
                    return 0; // Maintain existing sort for others
                });
            }
            currentPage = 1;
            renderUserTable();
        });

        // --- Pagination Event Listeners ---
        document.getElementById('prev-page').onclick = () => {
            if (currentPage > 1) {
                currentPage--;
                renderUserTable();
            }
        };

        document.getElementById('next-page').onclick = () => {
            const totalPages = Math.ceil(filteredUsers.length / usersPerPage);
            if (currentPage < totalPages) {
                currentPage++;
                renderUserTable();
            }
        };

        // --- Render User Table with Pagination ---
        function renderUserTable() {
            const tableBody = document.querySelector('#user-table tbody');
            tableBody.innerHTML = '';

            const totalPages = Math.ceil(filteredUsers.length / usersPerPage) || 1;
            const startIndex = (currentPage - 1) * usersPerPage;
            const endIndex = startIndex + usersPerPage;
            const usersToShow = filteredUsers.slice(startIndex, endIndex);

            if (usersToShow.length === 0) {
                tableBody.innerHTML = '<tr><td colspan="4" style="text-align: center; padding: 1rem; color: #888;">No users found.</td></tr>';
            } else {
                usersToShow.forEach(u => {
                    const btnClass = u.isPro ? 'secondary-btn' : 'primary-btn';
                    const btnText = u.isPro ? '‚ùå Remove PRO' : '‚úÖ Grant PRO';

                    const uName = (u.displayName || '').toLowerCase();
                    const uEmail = (u.email || '').toLowerCase();
                    const isPriority = PRIORITY_TERMS.some(t => uName.includes(t) || uEmail.includes(t));
                    const priorityIcon = isPriority ? ' <span title="Priority User" style="cursor:help;">üéñÔ∏è</span>' : '';

                    const row = `<tr style="border-bottom: 1px solid rgba(255,255,255,0.05); ${isPriority ? 'background: rgba(79, 70, 229, 0.05);' : ''}">
                        <td style="padding: 0.75rem 0;">${u.displayName || 'N/A'}${priorityIcon}</td>
                        <td style="padding: 0.75rem 0; font-size: 0.8rem;">${u.email}</td>
                        <td style="padding: 0.75rem 0;">${u.isPro ? 'üíé PRO' : 'Free'}</td>
                        <td style="padding: 0.75rem 0;">
                            <button class="${btnClass}" style="padding: 0.25rem 0.5rem; font-size: 0.75rem;" 
                                     onclick="toggleProStatus('${u.uid}', ${u.isPro}, '${(u.displayName || u.email || '').replace(/'/g, "\\'")}')">
                                ${btnText}
                            </button>
                        </td>
                    </tr>`;
                    tableBody.insertAdjacentHTML('beforeend', row);
                });
            }

            // Update pagination controls
            document.getElementById('page-info').innerText = `Page ${currentPage} of ${totalPages} (${filteredUsers.length} users)`;
            document.getElementById('prev-page').disabled = currentPage === 1;
            document.getElementById('next-page').disabled = currentPage >= totalPages;
        }

        // --- User Stats ---
        async function loadStats() {
            const usersSnap = await db.collection('users').get();
            const totalUsers = usersSnap.size;
            let proUsers = 0;

            allUsers = [];

            usersSnap.forEach(doc => {
                const u = doc.data();
                u.uid = doc.id;
                if (u.isPro) proUsers++;
                allUsers.push(u);
            });

            // Sort by name
            allUsers.sort((a, b) => (a.displayName || '').localeCompare(b.displayName || ''));

            filteredUsers = [...allUsers];
            currentPage = 1;
            renderUserTable();

            document.getElementById('total-users').innerText = totalUsers;
            document.getElementById('pro-users').innerText = proUsers;
        }
    </script>
</body>

</html>